# 第8章 数据库的管理

数据库的管理/保护：DBMS（数据库管理系统）对DB（数据库）的监控。

**实现：数据库的恢复、并发控制、完整性控制、安全性控制。**

DBS的最小逻辑单位：事务。

## 8.1 事务的概念

### 8.1.1 事务的定义

定义8.1  事务是构成**单一逻辑工作单元的操作集合**。DBS必须保证事务**正确，完整的执行**。

```sql
# 银行转账事务
T:BEGIN TRANSACTION;			/* 事务开始语句 */
  read(A);
  A := A - 50;
  write(A);
  if (A < 0): ROLLBACK;			/* 事务回退语句 */
  else {
  		read(B);
  		B := B + 50;
  		write(B);
  		COMMIT;}				/* 事务提交语句 */
```

COMMIT语句：事务执行成功，“提交”，所有更新都写入磁盘。

ROLLBACK语句：事务执行不成功，“回退”，撤销所有更新，数据库恢复初始状态。

read(X)：把数据X从磁盘的数据库，读到内存的缓冲区。

write(X)：把数据X从内存的缓冲区，写入磁盘的数据库。

**注意：write操作不一定导致数据立即写回磁盘。很可能先暂存在内存缓冲区，稍后再写回磁盘。**

### 8.1.2 事务的ACID性质

1. **原子性** Atomicity：不可分割。要么全部执行，要么一个不做。						[ 事务管理子系统 ]
2. **一致性** Consistency：一个事务独立执行的结果，应保持数据库的一致性。     [ 完整性子系统 测试 ]
3. **隔离性** Isolation：并发时，事务串行，不受其他数据干扰。                             [ 并发控制子系统 ]
4. **持久性** Durability：正确的事务对数据库的更新应该永久保留。                        [ 恢复管理子系统 ]

## 8.2 数据库的恢复

### 8.2.1 恢复的定义原则和方法

1. 恢复的定义

   **恢复管理子系统**采取一些列的措施保证在任何情况下**保持事务的原子性和持久性**，确保**数据不丢失、不破坏。**

   定义 8.2 **数据库的可恢复性**：系统能把数据库从破坏、不正确的状态，恢复到最近一个正确状态。

2. 恢复的基本原则和实现方法

   1. 转储和建立日志

      - 周期地对整个数据库复制。

      - 建立日志数据库。

   2. 发送故障时，分情况处理

      - 数据库破坏：复制最近一次数据到数据库，利用日志“重做”。
      - 数据库完好，数据损坏：利用日志“撤销”处理。

### 8.2.2 故障类型和恢复方法

软故障：系统故障；硬故障：介质故障

1. 事务故障：

   1. 可预期的：程序编写ROLLBACK 语句。
   2. 不可预期的：系统进行UNDO处理。

2. 系统故障：

   1. 定义：引起系统停止运转随之要求重新启动的事件。
   2. 特点：**正在运行的事务有影响，内存只能够数据丢失，不破坏数据库。**
   3. 重启时：1）对未完成事务进程UNDO处理；2）对已提交事务但更新还在缓冲区的事务进行REDO处理。

3. 介质故障：

   1. 特点：物理损坏，磁盘数据丢失。

   2. 恢复：

      - 重装转储的副本，恢复数据库到正确状态。

      - 在日志中找出转储以后所有已提交的事务。
      - 对已提交事务REDO处理。

### 8.2.3 检查点机制

1. 检查点方法

DBMS定时设置检查点。在检查点时刻才真正把数据写回磁盘，并在日志文件中写入检查点信息。

当DB需要恢复时，仅需恢复检查点之后还在执行的事务。

![image-20220516200716505](D:\Desktop\Notepic\image-20220516200716505.png)

T1 : 已经完成，并且写入磁盘，无需操作。

T2 和 T4：已经完成，没有写回，需要REDO。

T3 和 T5：还未完成，需要UNDO。

2. 恢复算法
   1. 根据日志文件建立事务重做队列和事务撤销队列。
      - 重做队列：正向扫描日志，添加故障前**COMMIT的事务**。
      - 撤销队列：正向扫描日志，添加故障前**未COMMIT的事务**。
   2. 对重做队列进行REDO，对撤销队列进程UNDO。
      - REDO：正向扫描日志，根据重做队列进行REDO。
      - UNDO：**反向**扫描日志，根据撤销队列进行UNDO（逆操作）。

### 8.2.4  运行记录优先原则

1. 至少要等相应运行记录（日志记录）已经写入运行日志文件后，才能允许事务往数据库中写记录；**“先日志，后数据库”**
2. 直至事务的所有运行记录（日志记录）都已经写入运行日志文件后，才能允许事务完成COMMIT处理。**“写全日志，才COMMIT”**

### 8.2.5 SQL对事务的支持

## 8.3 数据库的并发控制





