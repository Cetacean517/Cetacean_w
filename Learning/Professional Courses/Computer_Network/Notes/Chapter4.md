# 第四章 网络层
## 4.1 几个重要概念
### 4.1.1 网络层提供的两种服务
#### 虚电路服务
- 逻辑上的连接

#### 数据包服务
- 数据包服务
  - 尽量简单，向其上层只提供**简单灵活**的、**无连接**的、尽最**大努力交付**的数据报服务
- ( IP ) 数据报 = IP 分组
- **不提供服务质量承诺**、**不可靠**

#### 两种服务（优缺点 p117）
|对比的方面| 虚电路服务 | 数据报服务 |
|--|--|--|
|思路|**网络**保证可靠通信|**用户主机**保证可靠通信|
|连接的建立|有|无|
|终点地址|仅连接建立阶段使用，每个分组使用短的虚电路号|每个分组都有终点的完整地址，即**IP地址**|
|分组的转发|属于同一条虚电路的分组均按**照统一路由**进行转发|每个分组独立查找转发表进行转发|
|当节点出故障时|所有通过出故障的节点的虚电路均不能工作|出故障的节点可能会丢失分组，一些路由可能会发生变化|
|分组的顺序|按**发送顺序**到达终点|到达顺序，不一定按发送顺序|
|端到端的差错控制和流量控制|**网络/用户主机**负责|用户主机负责|

#### 可靠服务和连接的关系
##### 可靠
- 含义：数据无丢失、损坏或重复
- 用 **应答** 来实现，即接收端的反馈

##### 面向连接
- 只是保证传送顺序

**两者没有直接关系**

#### 4.1.2 网络层的两个层面
- 数据层面 / 转发层面
- 控制层面

## 4.2 网际协议IP
### IP协议及配套协议
- ARP 地址解析协议
- RARP 逆地址解析协议
- ICMP 网际控制报文协议
- IGMP 网际组管理协议
### 4.2.1 虚拟互联网络
#### 中间设备
- 物理层：转发器
- 数据链路层：网桥 / 桥接器, 交换机
- 网络层：路由器
- 网络层以上：网关

#### 路由器 交付方式
- 直接交付：无需经过路由器 （A和B在同一个网络）
- 间接交付：需经过几个路由器 （A和B不在同一个网络）

### 4.2.2 IP地址

#### 1. IP地址及其表示方法
- IP地址：连接到互联网上的每一台主机/路由器的每一个**接口**，分配一个在全世界范围内是唯一的**32位**的标识符。
- 点分十进制记法
- IP地址 ::= {<网络号>， <主机号>}
编址方法

#### 2. 分类的IP地址
- A类 n = 8  单播地址  
- B类 n = 16 单播地址 
- C类 n = 24 单播地址 
- D类 多播
- E类 保留地址
>
##### 特殊网络号
- 本网络：全0
- 本地回环测试：127

##### 特殊的主机号
- 本主机连接到的**单个网络地址**：全0
- 该网络**所有主机**：全1

```
主机IP :5.6.7.8, 则网络地址：5.0.0.0
A 类最大主机数：2^24 -2 
B 类最大主机数：2^16 -2 
C 类最大主机数：2^8 -2 
```

##### IP层转发分组流程
- 按照主机所在的网络地址来制作路由表
- 路由表 = 目的主机地址 + 下一条地址

#### 3. 无分类编址 CIDR
- IP地址 ::= { <网络前缀>，<主机号> }
- 构成超网/ CIDR编址
- 路由聚合
  - ISP分配的前缀不可修改。总个数
  - 分配总是从可修改的第一位开始，一般先分0再分1.
##### i. 网络前缀
- n位网络前缀，0 < n < 32
```
CIDR 表示：
128.14.35.7/20  前20位：网络前缀 （网络号），后12位：主机号
```
##### ii. 地址块
- CIR地址块：网络前缀都相同的IP
- **掌握导出网络地址的方法**
```
128.14.32.7    IP地址 未知网络地址
128.14.32.7/20 IP地址 网络前缀20位 可得网络地址
128.14.32.0/20 IP地址的地址块/网络前缀
```
##### iii.地址掩码/子网掩码
- 子网掩码：1：网络前缀位数 + 0 :主机号位数

```
A类网络 地址掩码：
1111 1111 0000 0000 0000 0000 0000 0000 = 255.0.0.0/8
```
- IP地址 AND 子网掩码 = 网络地址 `（保留网络前缀，清除主机号部分）`



### 4.2.4 地址解析协议 ARP
- ARP协议 ： IP -> MAC
  - ARP cache中存放 IP -> MAC 映射表，且动态更新

### 4.2.5 IP数据包格式
**首部固定部分20字节**
- 版本(4)
- 首部长度(4)
- 区分服务(8)
- 总长度 = 首部 + 数据和
  - MTU 以太网：1500字节 最长IP首部：60字节
  - 分片
- 标识(16)
- 标志(3)：分片有无
- 偏移量(13)：若分片，偏移位置
- 生成时间(8)：跳数（max:255） - 1
- 协议：ICMP 1 IP 4 TCP 6 UDP 17
- **首部校验和**：反码算数运算
- 源地址
- 目的地址
## 4.3 IP层转发分组过程
### 4.3.1 基于终点的转发
- 查找是否在本网络：分组目的地址 和 子网掩码 按位与
  - 是，直接交付
  - 否，给**路由器**处理
- 路由器找发送网络点：同上，匹配成功 N2 直接交付
- R1调用ARP得到MAC地址，交给N2上的主机

### 4.3.2 最长前缀匹配
- 一个分组在转发表中可以找到多个匹配，找最长的一个
- 网络前缀越长，地址块越小。

```
128.1.24.0/22
128.1.24.0/24 √
```
- 特定主机路由 / 主机路由 ： a.b.c.d /32
- 默认路由：0.0.0.0/0
#### 分组转发算法
- 提取**收到**分组的 **目的主机IP地址D**
- 有 **特定主机路由** ？
  - yes, 该路由下一跳
  - no, 查下一行
- 子网掩码 和 目的地址 **按位与**
  - match, 下一跳
  - no match， 继续到结束
- 有 **默认路由** ？
  - yes, 发送
  - no, 出错

## 4.4 网际控制报文协议 ICMP
### * 4.4.1 ICMP 报文的种类
#### ICMP差错报告报文
  - 终点不可达
  - 时间超过
  - 参数问题
  - 改变路由
##### 不应发ICMP差错报文的几种情况
- **ICMP差错报文**，不再发
- **第一个分片的数据报片的所有后序数据报片**，不再发
- **具有多播地址的数据报**，都不发
- 对于**特殊地址**(127.0.0.0 / 0.0.0.0)的数据报，不发
>

#### ICMP询问报文
- 回答请求 / 回送回答
- 时间戳请求 / 时间戳回答
## 4.6 互联的路由选择协议
### 4.6.1 基本概念
#### 2. 分层次的路由选择协议
- 内部网关协议 IGP 
  - RIP （分布式路由协议）
  - OSPF （分布式路由协议）
- 外部网关协议 EGP

### 4.6.2 内部网关协议 RIP
- 跳数，**超过16不可达**

#### 1. 特点
- 仅和**相邻路由交换信息**
- **交换本路由知道的所有信息**，即当前路由表
- 按**固定时间间隔**交换信息

#### 2. 距离向量算法
- 修改所有项目，**下一跳地址：X，距离 +1**
- 路由表 有**目的网络** ？
  - yes, 继续
  - **no, 添加**
- **下一条 = X** ?
  - **yes, 更新**
  - no, 继续
- **新距离更小** ?
  - **yes, 更新**
  - no, 不更改
- **3分钟**超过？
  - yes, **不可达 距离=16**

#### 其他
- 格式：首部(4) + 路由部分(20)
- 最大长度 = 4 + 20 * 25 = 504 bytes
- **好消息传播快，坏消息传播慢**
- 网络故障的RIP传输
- 放在UDP中

### 4.6.3 内部网关协议 OSPF(Open Shortest Path First)
#### 1. 特点
  - 使用洪泛法发送路由信息。（向本自治系统中所有路由器发送）
  - 发送相邻的路由信息
  - 仅路由发生变化，才发送所有路由信息

##### OSPF的区域
- **主干路由器**：主干区域
- **区域便捷路由器**：主干 <-> 其他区域
- **自治系统边界路由器**：本系统 <-> 其他系统
#### 2. 5中分组类型
- 1. 问候
- 2. 数据库描述
- 3. 链路状态请求
- 4. 链路状态更新
- 5. 链路状态确认

##### 用IP数据包直接传输
### 4.6.4 外部网关协议 BGP
#### 1. 特点
- 最佳路由（不一定最短）

#### 2. BGP路由
- 封装在TCP中
## 4.6 IP多播
## 4.7 其他网络举例
