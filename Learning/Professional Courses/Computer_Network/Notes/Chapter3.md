# 第三章 数据链路层
```
出错就丢 不可靠的
规程 = 协议
> 重点：3.3 3.6 3.7
```
- 点对点信道：一对一通信
- 广播信道：  一对多通信

## 3.1 数据链路层的基本概念
### 3.1.1 数据链路和帧
- **链路 / 物理链路** link：
  - 一个节点**到相邻节点**的一段物理线路（有线/无线），**中间没有其他交换节点。**
  - 路径的一部分
- **数据链路 / 逻辑链路** data link
  - 实现协议的软硬件 + 链路
- **帧**：**点对点**信道  数据链路层的 协议**数据单元**

#### 点对点信道 通信的主要步骤
- 数据链路层把网络层交下来的**IP数据报添加首部和尾部**，**封装成帧**。
- 把封装好的帧，**发送**给对方的数据链路层。
- 对方的数据链路收到的帧**无差错**，则从收到的帧中**提取出IP数据报**交给上面的网络层；**否则，丢弃帧**。

### 3.1.2 三个基本问题
#### 1. 封装成帧
- 原理：添加首部和尾部
- 作用：帧定界
- 帧的数据部分长度上限：最大传送单元 MTU Maximum Transfer Unit
- 帧定界符：
  - SOH Start of Header
  - EOT End of Transmission

#### 2. 透明传输
- 透明：对传送的数据来说，帧定界符就好像不存在
- **字节填充 / 字符填充** ： 
  - 发送端：SOH / EOT / ESC 前插入转义字符 "ESC"
  - 接收端：删除转义字符

#### 3. 差错检测
- 比特差错：0变1 1变0
- 检错技术：**循环冗余码CRC Cyclic Redundancy Check**
##### 概念辨析
- 无比特差错：没有0和1的错误
- 无传输差错：没有帧丢失、帧重复、帧失序；没有比特差错。
- 可靠传输：没有帧丢失、帧重复、帧失序

## 3.2 组帧
- 组帧：在一段数据的前后分别添加首部和尾部
- 目的：使接收方能准确识别帧的边界（**帧定界**）

### 帧定界（帧同步）的方法
- 字节计数法
- 字符填充法
- 比特填充法
- 违法编码法
#### 1. 字节计数法
- 思想：在帧头设置一个长度域，放置该帧的字节数，当收方收到帧后，通过帧的长度，确定帧的开始。
- 问题：长度域错误，帧同步完全丢失。

#### 2. 字符填充法（掌握）
- 思想：使用特殊ASCII字符，作为首尾定界。
- 问题：如果出现与帧定界符一样的字符，产生区分结束点问题。
- 解决：数据段中的所有字符前，新增填充字符
- 缺点：传输二进制比特不变
```
Start of Header 0x01
End of Transmission 0x04
ESC 0x1B

例：以SOH为开始帧定界符，EOT为结束帧定界符。
SOH // ESC A / ESC A / ESC SOH / ESC C / ESC EOT / ESC ESC // EOT
```
#### 3. 比特填充法（掌握）
- 思想：
  - 以特殊比特模式01111110作为起始和结束标志
  - 发送方边发边查，每连续5个1后，插入0（修改）
  - 接受方边收边查，每联系5个1后，删除0（还原）
- 优点：通用性强

```
例：发送数据
1. 01011111 -> 010111110  //以5个1结尾，要加0
2. 01111100 -> 011111000  //只有5个1，也要加0
```
#### 4.违法编码法
- 思想：若物理截止上由荣誉码字，利用冗余定界。

## 3.3 差错控制
- 前向纠错
- 自动重发请求
- 若发送信息丢失，接收端收不到？
  - -> 发送端引入计数器，计时器时间到期，仍为收到应答。则默认丢失，进行重发。
- 若多发怎么办？ 
  - -> 为避免相同帧多次接收，对帧进行编号。
- 差错如何发现？
  - 检错码：奇偶校验码，CRC（CRC必考）
  - 纠错码：海明码（汉明码）

### 3.3.1 差错控制技术
#### *前向纠错 FEC - Forward Error Correction
- 应用：航天/航空， 没有反向信道或反向传输时间很长的场合
- 优点；实时性好
- 缺点：传送效率低

#### *自动重复请求 ARQ – Automatic Repeat reQFHuest
- 原理：检测冗余位，正确/错误，给出应答，（重发）。
- 优点：设备简单，只重复无纠错
- 缺点：信息传递连贯性差

### 3.3.2 差错编码技术
#### 差错编码
- 差错编码：数据块中插入冗余信息的过程
- 思想：使数据块中的比特信息形成管理，进行判断

#### 检错码
- 构造
  - 检错码 = 信息位 + 冗余校验位
  - 码字长 n = K (信息位位数) + r (校验位位数)
  - 编码效率 R = K / n

#### 1. *奇偶校验码
- 奇校验：码字中'1'为奇数个。
- 偶校验：码字中'1'为偶数个。
- 奇偶校验码：
  - 水平奇/偶校验码
  - 垂直奇/偶校验码
  - 水平垂直奇/偶校验码（方阵校验）

##### *水平奇/偶校验
- 编码效率： Q/(Q+1) (信息字段占Q个比特)
- 应用：
  - 异步传输：偶校验
  - 同步传输：奇校验

##### *垂直奇/偶校验
```
0111001|
0010101|
0101011|
1010101|
0101101 //校验位
```
- 编码效率：PQ/P(Q+1) （假设信息分组占Q行P列）

##### *水平垂直奇/偶校验
- 编码效率：PQ/(P+1)(Q+1) （假设信息分组占Q行P列）

#### 2. 循环冗余码 CRC Cyclic Redundancy Check（重要！！！）
```
> - 使用最广泛的检错码
> - 漏检率低，实现简单

- 原理
  - 发送方，接收方实现约定一个除数K
  - 约定发送数据能被K整除
  - 接收方检测，若被K整除，则无差错；反之，出错。
- CRC（多项式编码）：每一串0和1，都和对应多项式的系数。
  - 101101 $\rightleftarrows {x^5 + x^3 + x^2 + 1}$
```
##### 冗余码的计算（重要）
- 除数 P：生成多项式 P(X)（确定的n+1位）
- 被除数：在数据位后面添加n个0，其中n是生成多项式位数-1(即最高幂次)
- 除法：做二进制除法，把减法当做模二加法，不进位。
- **冗余码 / 帧检验序列 FCS Frame Check Sequence**：
  - 即余数，位数也是n位。把余数作为冗余码添加上在最后。
- 传输数据：源数据 + 冗余码

##### 发送方用P生成冗余位
- 注意发送的是0 / 1序列，还是多项式

##### 接收方用P进行校验
- T(X) 传输帧多项式 /P(X) 生成多项式 
  - ≠0(除不尽)，则有错（1）
  - =0(除尽)，则无错或漏检（2）
- 漏检：只要选择位数足够的P，可以使得差错的概率足够小。


##### CRC算法解题思路
```
1. 已知：信息多项式M(X)，生成多项式P(X)
   求：传送的信息序列
  + 多项式与二进制代码的对应关系
  + 求出余数
    - 根据P(X)得到n 
    - 二进制除法

2. 求某个比特出错时，接收方能否检验出来
  - 用接收到的序列/生成多项式，看余数是否为0
```

#### 3.信源编码和信道编码
- 信源编码：无失真的压缩信息
- 信道编码

##### 汉明码
- 汉明码属于**信道编码**，是**纠错码**
- 码距（汉明码距离）：不同二进制的位数个数
- 编码系统的码距：整个编码系统中任意两个码字的最小距离。

##### 两个结论
- 如果要检测出d个比特的错，则编码的汉明距离至少为d+1。
- 如果要纠正d个比特的错，则编码集的汉明距离至少因为2d+1。

```
1. 对于3位的汉明码，若要检测出1个比特的错，汉明编码的距离至少为2.（留空间）
  例：000,011,101...都有着不同的含义。如果有一位写错，000变为001，则001并不是有效的汉明编码。因此可以检错。如果只有一位，那么每一个编码都是有效位，则无法检测出错误。
2.（可二分）只有对于存在距离更近的汉明码，才能够实现纠错。
```

##### 发送方冗余位计算
- $2^r >= K + r + 1$

```
若k = 5, 则 r = 4
```

##### 汉明码计算
- 确定校验比特和信息比特的位置
- 将每个信息比特的位置写成2的次幂之和的形式

## 3.4 点对点协议 PPP
### 3.4.1 PPP协议的特点
#### 组成
- 数据部分 IP数据报
- 链路控制协议 LCP Link Control Protocol
- 网络控制协议 NCP Network Control Protocol
### 3.2.2 PPP协议格式
#### 1. 字段含义
```
F标志 + A地址 + C控制 + 协议 + 信息部分（IP数据报）+FCS + F标志
```

#### 透明传输问题
##### 字节填充法
- 出现每一个(7D5E = 7E), (7D5D = 7D)

```
编码后数据：
7D 5E EE FE 26 7D 5D 5D 7D 5D 7D 5E
(7E) EE FE 26 (7D) 5D (7D) (7E)
```
##### 比特填充法
- 发送方："11111" + 0
- 接收方："111110" - 0
### 3.2.3 PPP 工作状态
- 设备之间无连接
- 物理链路
- LCP链路
- 已鉴别的LCP链路
- 已鉴别的LCP链路和NCP链路

## 3.5 使用广播信道的数据链路层
### 3.5.1局域网的数据链路层
#### 特点
- 网络为一个单位所拥有，且地利范围和站点数目均有限。
#### 优点
- 具有**广播**功能。共享软硬件资源
- 便于系统的**扩展**和**演变**，设备的位置可灵活调整和改变。
- 提高系统的**可靠性**、**可用性**和**生存性**。

#### 拓扑分类
- 星形网
- 环形网
- 总线网

#### 局域网信道分配策略
- 静态划分信道：代价高，局域网不适用
- **动态媒体接入控制 / 多点接入**：
  - 随机接入：**随机**发送信息，若**产生碰撞**，则**解决碰撞**。
    - 特点：信道利用率低、网络延迟短
    - 适用：以太网；卫星通讯
  - 受控接入：发送信息服从统一控制。

#### 1. 以太网的两个主要标准
- 逻辑链路控制 LLC Logical Link Control
- **媒体接入控制 MAC** Medium Access Control ：
  - 与接入媒体传输相关内容

#### 2. 适配器的作用
- 适配器：计算机与外界局域网连接的工具
  - **网络接口卡 / 网卡** **NIC** Network Interface Card 

>
- 适配器 - 局域网 ： 电缆 / 双绞线 串行传输
- 适配器 - 计算机 ： I/O总线 并行传输

>
- 存储器：计算机软件地址 IP地址
- 适配器：计算机硬件地址 MAC地址 

##### 网卡作用
- 进行串行/并行转换。
- 对数据进行缓存。
- 实现以太网协议。
- 在计算机的操作系统安装设备驱动程序。

### 3.5.2 CSMA/CD 协议
#### 总线一对一通信
- 每台计算机适配器 有 独有的地址
- 发送：帧首部 写 接收地址
- 接收：仅目的地址 可以接收
- 不适配，则丢弃

#### 两种方式
- 无连接：不编号，不要求确认信息
- 曼彻斯特编码

#### CSMA / CD 协议
- Carrier Sense Multiple Access with Collision Detection 载波监听多点接入/碰撞检测
  - 载波监听：边发送边监听
  - 碰撞检测/冲突检测 ： 有多个站同时发送，则及时停止

```
> - 有人发送，要等待，无人发送，可以发送。
> - 但不能完全避免碰撞。
> 例如：从A->B发送数据，数据从A发送的过程中，B端也发送数据，会产生冲突。
```
##### 如何检测冲突
争用期
- 争用期（碰撞窗口）：2τ 【用于确定最短有效帧长】
- 最短有效帧长：2τ * 带宽 (M bps)
- 无效帧：长度小于最短有效帧长的帧
> 以太网的争用期：51.2μs

##### 检测到碰撞后 重传
二进制指数退避算法
1. 令基本退避时间T=2τ （即争用期）；**51.2μs**
2. k=min[重传次数，10]； (**k最大为10**)
3. r=在 [0, 1, …, (2k-1)] 中随机取一个数；
4. 退避时间=rT。
5. 超过16次，则丢弃，并报告
##### 最短帧长
- 64 字节 512比特
- 数据过短，则加入填充字符
- 小于64字节，认为是废弃，丢弃。
##### 强化碰撞
- 发生碰撞，则发送32比特/48比特人为干扰信号
##### 小结
特点
- 先听后讲
- 边讲边听
- 冲突停止
- 随机等待
```
判断
- CSMA/CD一定可以减少争用型总线上的冲突（×）
```



### 3.5.3 使用集线器的星型拓扑
- 集线器
  - 工作在物理层
- 以太网 10BASE-T 双绞线
  - 10： 10Mbit/s
  - BASE： 基带信号
  - T: 双绞线

### 3.5.4 以太网的信道利用率
- 参数a= τ (传播时延) / T0 (发送时间)
- T0 = L ( bit 帧长) / C ( bit/s 数据发送速率)
- a越小，利用率越高
- 判断：
  - 当数据率一定时，以太网的连线的长度受到限制，否则 τ 的数值会太大。
  - 以太网的帧长不能太短，否则 T0 的值会太小，使 a 值太大。
## 3.6 以太网的MAC层
### 3.6.1 以太网的标准
#### 1. MAC层的硬件地址
- 硬件地址 = 物理地址 = MAC地址 （6字节）= 适配器地址 / 适配器标识符
>
- 注册管理机构 RA Registration Authority:分配 **前3字节** 
  - 组织唯一标识符 OUI Organizationally Unique Identifier / 公司标识符 compan_id

>
- 第一字节 最低有效位：I/G Individual/Group
  - 0 ：单个地址站
  - 1 ：组地址

- 网卡地址或网卡标识符常写为：EUI-48
##### 网卡检查MAC地址
- 单播帧：一对一
- 广播帧：一对全体
- 多播帧：一对多

#### 2. MAC 帧格式
- 以太网V2的格式 （5个字段）
- MAC帧 = 【同步码】（8）+ 目的地址（6）+ 源地址（6）+ 类型 （2）+ 数据字段 （46 -1500）+FCS（4）
  - 类型：标志上一层用的是什么协议
  - 数据字段：最短46 = 64（以太网的最短有效帧）-18（必有）
  - 同步码：实现比特同步 
    - 前同步码（7）+帧开始定界符（1）
- 无效MAC帧：直接丢弃，无需重传。
  - 帧长度 非整数字节
  - FCS有差错
  - 数据字段不在 46 - 1500 之间

最小帧间隔
- 最小间隔为 9.6 μs，相当于 96 bit 的发送时间。

```
格式无需默写，需要知道
```

## 3.7 扩展的以太网
### 3.7.1 物理层扩展以太网
- 本质：不同的协议层次上实现协议的彼此转换。
- 互联设备
  - 交换机（重点）
中继器（重发器）
- 连接两个同轴电缆以太网，将信号放大整形后，以延伸网络的传输距离。
- 不具有信号通路的选择功能

集线器
- 多个站点连接在同一个总线上。
- 冲突域（碰撞域）：同一时间，仅有一个站发送数据
- 优点：
  - 不同碰撞域的局域网上的计算机能互联互通
- 缺点：
  - 总吞吐量没有提高。
  - 数据率不一致，不能连接。
  - 不能交换。

### 3.7.2 数据链路层扩展以太网
#### 网桥和交换机
- 网桥：根据收到帧 MAC地址的 目的地址 进行 **转发** 和 **过滤**
- 交换式集线器/第二层交换机/交换机：**数据链路层** 工作
- 交换机接口 -> 主机； 网桥接口 -> 网段。

#### 网桥分类
- 固定路由网桥
- 透明网桥（使用最多）
- 源路由网桥

#### 1. 以太网交换机放入特点
- 实质：**多接口**的网桥
- **全双工方式**
- 并行性：能同时连通多对接口，使多对主机能同时通信。
- 特点：
  - 即插即用设备，其内部的帧交换表（又称为地址表）是通过自学习算法自动地逐渐建
立起来的。
- 优点：
  - 用户独享带宽，增加了总容量
  - 价格低
- 交换方式
  - 存储转发方式
  - 直通方式
#### 2. 以太网交换机的自学习功能
- 无路径，记录**出发**路径（源地址 + 端口号）
- 广播找**接收**路径，不匹配丢弃，匹配则记录
##### 生成树协议 STP Spanning Tree Protocol
- 切断链路，解决回路问题


### 3.7.3 虚拟局域网 VLAN Virtual LAN 
- VLAN：给用户提供**一种服务**，**不是一种新型的局域网**
- MAC帧格式：
  - 目的地址（6） + 源地址（6） + **VLAN标记(4)** + 类型（2）+ 数据 （46-1500）+ FCS
  - VLAN标记：长度/类型 = 802.1Q标记类型(2字节 固定) + 标记控制信息 VID (2字节)
- max ： 1522 （普通的 1518）
- 优点：
  - 安全性好
  - 网络分段：逻辑分段，与物理位置无关。
  - 灵活性好

## 3.8 高速以太网
- 高速以太网：>= 100 Mb/s 的以太网
### 3.8.1 100BASE-T 以太网
- 快速以太网 Fast Ethernet ： 100 BASE-T 以太网
- 双绞线  100 Mb/s 基带信号  星型拓扑以太网
- IEEE802.3 的 CSMA/CD 协议
- 帧间时间间隔：0.96 μs

### 3.8.2 吉比特以太网
- 允许在 1 Gb/s 下全双工和半双工两种方式工作。
- 使用 802.3 协议规定的帧格式。
- 在半双工方式下使用 CSMA/CD 协议（全双工方式不需要使用 CSMA/CD 协议）。
- 与 10BASE-T 和 100BASE-T 技术向后兼容
- 载波延伸(carrier extension)：增加到512比特 填充


